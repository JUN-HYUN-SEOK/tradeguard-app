import sys

# íŒŒì¼ ì½ê¸°
with open('trade_guard_app.py', 'r', encoding='utf-8') as f:
    lines = f.readlines()

# 1013ë²ˆ ë¼ì¸ê¹Œì§€ë§Œ ìœ ì§€ (0-based indexì´ë¯€ë¡œ 0-1012)
fixed_lines = lines[:1013]

# ëˆ„ë½ëœ í•¨ìˆ˜ë“¤ ì¶”ê°€
new_code = '''
        output.seek(0)
        return output.getvalue()
    except Exception as e:
        st.error(f"ì—‘ì…€ ìƒì„± ì˜¤ë¥˜: {e}")
        return None

def create_word_document(results, summary_data):
    """ì›Œë“œ ë¬¸ì„œ ìƒì„± (íŠ¹ì´ê±´ë§Œ ìƒì„¸ í¬í•¨)"""
    try:
        doc = Document()
        doc.add_heading('ìˆ˜ì…ì‹ ê³  RISK ë¶„ì„ ë³´ê³ ì„œ', 0)
        doc.add_paragraph(datetime.datetime.now().strftime("%Y-%m-%d"))
        
        if summary_data:
            doc.add_heading('ì¢…í•© ìš”ì•½', level=1)
            p = doc.add_paragraph()
            p.add_run(f"ì „ì²´ ì‹ ê³  ê±´ìˆ˜: {summary_data.get('ì „ì²´ ì‹ ê³  ê±´ìˆ˜', 0):,} ê±´").bold = True
            
            if 'Riskë¶„ì„' in summary_data:
                risk_df = summary_data['Riskë¶„ì„']
                risk_found = risk_df[risk_df['ì‹ ê³ ê±´ìˆ˜'] > 0]
                
                if len(risk_found) > 0:
                    p.add_run(f"\\n\\nâš ï¸ ë°œê²¬ëœ Risk ìœ í˜•: {len(risk_found)}ê±´").bold = True
                    for _, row in risk_found.iterrows():
                        p.add_run(f"\\n- {row['Risk ìœ í˜•']}: {row['ì‹ ê³ ê±´ìˆ˜']:,} ê±´ ({row['ë¹„ìœ¨(%)']:.1f}%)")
                else:
                    p.add_run("\\n\\nâœ… íŠ¹ì´ì‚¬í•­ì´ ë°œê²¬ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.").bold = True
        
        has_findings = False
        section_titles = {
            'eight_percent': ('8% í™˜ê¸‰ ê²€í† ', ['ìˆ˜ì…ì‹ ê³ ë²ˆí˜¸', 'ì„¸ë²ˆë¶€í˜¸', 'ê´€ì„¸ì‹¤í–‰ì„¸ìœ¨']),
            'zero_risk': ('0% ì„¸ìœ¨ ìœ„í—˜', ['ìˆ˜ì…ì‹ ê³ ë²ˆí˜¸', 'ì„¸ë²ˆë¶€í˜¸', 'ì„¸ìœ¨êµ¬ë¶„']),
        }
        
        for key, (title, cols) in section_titles.items():
            data = results.get(key)
            if data is not None and not data.empty:
                has_findings = True
                doc.add_heading(title, level=1)
                doc.add_paragraph(f'ì´ {len(data):,} ê±´ì´ ì‹ë³„ë˜ì—ˆìŠµë‹ˆë‹¤.')
        
        if not has_findings:
            doc.add_heading('ë¶„ì„ ê²°ê³¼', level=1)
            doc.add_paragraph('âœ… íŠ¹ì´ì‚¬í•­ì´ ë°œê²¬ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.')
        
        doc.add_paragraph()
        footer = doc.add_paragraph('Generated by ê´€ì„¸ë²•ì¸ ìš°ì‹ ')
        footer.alignment = 1
        
        doc_output = io.BytesIO()
        doc.save(doc_output)
        doc_output.seek(0)
        return doc_output.getvalue()
    except Exception as e:
        st.error(f"ì›Œë“œ ë¬¸ì„œ ìƒì„± ì¤‘ ì˜¤ë¥˜ ë°œìƒ: {str(e)}")
        return None

def create_html_report(results, summary_data):
    """HTML ë³´ê³ ì„œ ìƒì„±"""
    try:
        html = f"""<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>ìˆ˜ì…ì‹ ê³  RISK ë¶„ì„</title>
</head>
<body>
    <h1>ìˆ˜ì…ì‹ ê³  RISK ë¶„ì„ ë³´ê³ ì„œ</h1>
    <p>Generated by ê´€ì„¸ë²•ì¸ ìš°ì‹ </p>
</body>
</html>"""
        return html
    except Exception as e:
        st.error(f"HTML ë³´ê³ ì„œ ìƒì„± ì¤‘ ì˜¤ë¥˜: {str(e)}")
        return None

def main():
    st.title("ğŸ›¡ï¸ TradeGuard")
    st.sidebar.caption("made by ì „ìë™")
    
    uploaded_file = st.file_uploader("íŒŒì¼ ì—…ë¡œë“œ", type=['xlsx', 'xls', 'csv'])
    if uploaded_file:
        df_original = read_excel_file(uploaded_file)
        if df_original is not None:
            st.success("ë°ì´í„° ë¡œë“œ ì™„ë£Œ!")
            
            if st.sidebar.button("ë¶„ì„ ì‹œì‘"):
                results = {}
                results['summary'] = create_summary_analysis(df_original)
                
                excel_data =  create_excel_file(df_original, results, results.get('summary', {}))
                if excel_data:
                    st.download_button("ì—‘ì…€ ë‹¤ìš´ë¡œë“œ", excel_data, "report.xlsx")

if __name__ == "__main__":
    main()
'''

# ìˆ˜ì •ëœ ë‚´ìš© ì“°ê¸°
with open('trade_guard_app_fixed.py', 'w', encoding='utf-8') as f:
    f.writelines(fixed_lines)
    f.write(new_code)

print("íŒŒì¼ ìˆ˜ì • ì™„ë£Œ! trade_guard_app_fixed.py ìƒì„±ë¨")
